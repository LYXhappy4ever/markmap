<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TreeMind Pro - äº¤äº’ç»ˆæç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --primary-color: #4a90e2;
            --selection-bg: rgba(74, 144, 226, 0.2);
            --selection-border: #4a90e2;
            --hover-bg: #f5f5f5;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- å·¥å…·æ  --- */
        .toolbar {
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            z-index: 50;
            height: 40px;
        }
        .btn { padding: 5px 12px; border-radius: 4px; border: none; background: var(--primary-color); color: white; cursor: pointer; font-size: 13px; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-icon { background: transparent; color: #555; padding: 4px 8px; font-size: 16px; border-radius: 4px; }
        .btn-icon:hover { background: #eee; }

        /* --- ä¸»å®¹å™¨ --- */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; width: 100%; }

        /* --- é¢æ¿æ ·å¼ --- */
        .panel {
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), min-width 0.3s ease;
            overflow: hidden;
        }

        #left-panel { width: 260px; min-width: 150px; border-right: 1px solid var(--border-color); z-index: 10; }
        #left-panel.collapsed { width: 0 !important; min-width: 0 !important; border-right: none; }

        #middle-panel { width: 450px; min-width: 200px; border-right: 1px solid var(--border-color); z-index: 9; }
        #middle-panel.collapsed { width: 0 !important; min-width: 0 !important; border-right: none; }

        /* æ‹–æ‹½æ¡ */
        .resizer {
            width: 5px; cursor: col-resize; background: transparent; z-index: 20;
            margin-left: -2px; margin-right: -3px; flex-shrink: 0;
        }
        .resizer:hover, .resizer.active { background: var(--primary-color); }
        .resizer.hidden { display: none; }

        #right-panel { flex: 1; background: #fff; position: relative; min-width: 0; }

        /* --- æ ‘å½¢åˆ—è¡¨ --- */
        .tree-container { flex: 1; overflow: auto; padding-bottom: 50px; position: relative; }
        .tree-content-wrapper { min-width: 100%; display: inline-block; }

        .tree-item {
            display: flex; align-items: center; height: 28px; cursor: pointer;
            white-space: nowrap; border: 1px solid transparent; box-sizing: border-box;
        }
        .tree-item:hover { background-color: var(--hover-bg); }
        .tree-item.selected { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .tree-item.drag-over { border: 2px dashed #f59e0b; background: #fffbe6; }

        .arrow { width: 24px; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 10px; }
        .arrow:hover { color: #333; }
        .arrow.open { transform: rotate(90deg); }
        .icon { margin-right: 6px; }

        /* é‡å‘½åè¾“å…¥æ¡† */
        .rename-input {
            border: 1px solid var(--primary-color); outline: none; padding: 2px 4px;
            font-size: 14px; font-family: inherit; width: 100%;
        }

        /* --- å³é”®èœå• (Context Menu) --- */
        .context-menu {
            position: fixed; background: white; border: 1px solid #ccc;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 4px;
            display: none; flex-direction: column; z-index: 1000; padding: 4px 0;
        }
        .menu-item {
            padding: 6px 20px; cursor: pointer; font-size: 13px; color: #333; display: flex; align-items: center; gap: 8px;
        }
        .menu-item:hover { background: #f0f7ff; color: var(--primary-color); }
        .menu-separator { height: 1px; background: #eee; margin: 4px 0; }

        /* æ¡†é€‰ */
        #selection-box { position: absolute; background: var(--selection-bg); border: 1px solid var(--selection-border); display: none; pointer-events: none; z-index: 100; }

        /* ç¼–è¾‘å™¨ & è„‘å›¾ */
        textarea { width: 100%; height: 100%; border: none; padding: 20px; resize: none; outline: none; background: #fafafa; font-family: 'Consolas', monospace; box-sizing: border-box; font-size: 14px; }
        #markmap-container { width: 100%; height: 100%; }
        svg { width: 100%; height: 100%; }
        input[type="file"] { display: none; }
        
        /* æ‹–æ‹½å…¨å±€é«˜äº® */
        .tree-container.drag-enter-active { background-color: #f0f9ff; box-shadow: inset 0 0 0 2px var(--primary-color); }
        
        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 15px; }
        .modal-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
    </style>
</head>
<body oncontextmenu="return false;"> <div class="context-menu" id="contextMenu">
        <div class="menu-item" onclick="triggerRename()">âœï¸ é‡å‘½å</div>
        <div class="menu-item" onclick="deleteSelected()">ğŸ—‘ï¸ åˆ é™¤</div>
        <div class="menu-separator"></div>
        <div class="menu-item" onclick="exportAsHTML()">ğŸŒ å¯¼å‡ºä¸º HTML (è„‘å›¾)</div>
        <div class="menu-item" onclick="exportSelected()">ğŸ“„ å¯¼å‡ºä¸º æ•°æ® (JSON)</div>
    </div>

    <div class="modal-overlay" id="customModal">
        <div class="modal-box">
            <div style="font-weight:bold" id="modalTitle">æ ‡é¢˜</div>
            <input type="text" class="modal-input" id="modalInput">
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="confirmModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <strong>TreeMind Pro</strong>
        <div style="width:1px; height:15px; background:#ddd; margin:0 10px;"></div>
        <button class="btn btn-icon" onclick="togglePanel('left')">ğŸ“š</button>
        <button class="btn btn-icon" onclick="togglePanel('middle')">ğŸ“</button>
        <div style="flex:1"></div>
        <button class="btn btn-icon" onclick="copyNodes()">ğŸ“‹</button>
        <button class="btn btn-icon" onclick="cutNodes()">âœ‚ï¸</button>
        <button class="btn btn-icon" onclick="pasteNodes()">ğŸ“Œ</button>
        <div style="width:1px; height:15px; background:#ddd; margin:0 10px;"></div>
        <button class="btn" onclick="triggerImport()">ğŸ“¥ å¯¼å…¥</button>
        <button class="btn btn-outline" onclick="exportSelected()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        <input type="file" id="fileInput" multiple>
    </div>

    <div class="main-container">
        <div id="left-panel" class="panel">
            <div style="padding:10px; border-bottom:1px solid #ddd; background:#f9f9f9; display:flex; gap:5px; flex-shrink: 0;">
                <button class="btn btn-sm" style="font-size:12px;" onclick="promptCreate('file')">ğŸ“„ æ–‡ä»¶</button>
                <button class="btn btn-sm" style="font-size:12px;" onclick="promptCreate('folder')">ğŸ“‚ ç›®å½•</button>
                <div style="font-size:10px; color:#999; margin-left:auto; line-height:24px;">å³é”®ç®¡ç† / æ‹–æ‹½å¯¼å‡º</div>
            </div>
            <div class="tree-container" id="treeContainer">
                <div id="selection-box"></div>
                <div class="tree-content-wrapper" id="treeContent"></div>
            </div>
        </div>
        <div class="resizer" id="resizer-left"></div>

        <div id="middle-panel" class="panel">
            <div style="padding:8px; background:#f1f1f1; border-bottom:1px solid #ddd; font-size:12px; color:#666; flex-shrink: 0;" id="editorStatus">æœªé€‰æ‹©</div>
            <textarea id="editor" disabled></textarea>
        </div>
        <div class="resizer" id="resizer-middle"></div>

        <div id="right-panel">
            <div id="markmap-container"></div>
        </div>
    </div>

    <script>
        // --- æ•°æ®ä¸çŠ¶æ€ ---
        let root = { id: 'root', name: 'Root', type: 'folder', children: [], isOpen: true };
        let selectedIds = new Set();
        let activeFileId = null;
        let clipboard = { nodes: [], mode: null };
        let savedWidths = { left: 260, middle: 450 };
        let editingId = null; // å½“å‰æ­£åœ¨é‡å‘½åçš„èŠ‚ç‚¹ID

        // Markmap & JSZip
        const { Markmap, Transformer } = markmap;
        const transformer = new Transformer();
        let mm;
        
        function initMarkmap() {
            document.getElementById('markmap-container').innerHTML = '<svg id="mindmap"></svg>';
            mm = Markmap.create('#mindmap', null, {});
        }

        // --- 1. æ¸²æŸ“ä¸é‡å‘½åé€»è¾‘ ---
        function renderTree() {
            const container = document.getElementById('treeContent');
            container.innerHTML = '';

            function createNodeEl(node, level) {
                const div = document.createElement('div');
                div.className = 'tree-item';
                div.dataset.id = node.id;
                div.style.paddingLeft = (level * 20) + 'px';
                if (selectedIds.has(node.id)) div.classList.add('selected');

                // æ‹–æ‹½
                div.draggable = true;
                div.ondragstart = (e) => handleDragStart(e, node);
                div.ondragover = (e) => handleDragOver(e);
                div.ondrop = (e) => handleDrop(e, node);
                
                // å³é”®èœå•
                div.oncontextmenu = (e) => showContextMenu(e, node);

                // ç‚¹å‡»
                div.onclick = (e) => handleItemClick(e, node);
                div.ondblclick = (e) => { e.stopPropagation(); if(node.type==='folder'){node.isOpen=!node.isOpen; renderTree();} };

                // ç®­å¤´
                const hasChild = node.type === 'folder' && node.children.length;
                const arrow = document.createElement('div');
                arrow.className = (hasChild && node.isOpen) ? 'arrow open' : 'arrow';
                arrow.textContent = hasChild ? 'â–¶' : '';
                arrow.onclick = (e) => { e.stopPropagation(); node.isOpen = !node.isOpen; renderTree(); };

                const icon = document.createElement('span');
                icon.className = 'icon';
                icon.textContent = node.type === 'folder' ? 'ğŸ“‚' : 'ğŸ“„';

                div.appendChild(arrow);
                div.appendChild(icon);

                // é‡å‘½åé€»è¾‘ï¼šå¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                if (editingId === node.id) {
                    const input = document.createElement('input');
                    input.className = 'rename-input';
                    input.value = node.name;
                    input.onclick = e => e.stopPropagation(); // é˜²æ­¢ç‚¹å‡»è¾“å…¥æ¡†è§¦å‘é€‰ä¸­
                    
                    const finishRename = () => {
                        if (input.value.trim()) node.name = input.value.trim();
                        editingId = null;
                        renderTree();
                    };
                    
                    input.onblur = finishRename;
                    input.onkeydown = (e) => { if(e.key === 'Enter') finishRename(); };
                    
                    div.appendChild(input);
                    // è‡ªåŠ¨èšç„¦
                    setTimeout(() => input.focus(), 10);
                } else {
                    div.appendChild(document.createTextNode(node.name));
                }

                container.appendChild(div);
                if (node.type === 'folder' && node.isOpen && node.children) {
                    node.children.forEach(c => createNodeEl(c, level + 1));
                }
            }
            if(!root.children.length) container.innerHTML = '<div style="padding:20px;color:#999;font-size:12px;text-align:center;">æš‚æ— æ–‡ä»¶<br>ä»ç”µè„‘æ‹–å…¥æ–‡ä»¶</div>';
            else root.children.forEach(c => createNodeEl(c, 0));
        }

        // --- 2. å³é”®èœå• (Context Menu) ---
        const ctxMenu = document.getElementById('contextMenu');
        let ctxNodeId = null; // å³é”®é€‰ä¸­çš„èŠ‚ç‚¹

        function showContextMenu(e, node) {
            e.preventDefault();
            e.stopPropagation();
            
            // å¦‚æœå³é”®çš„ä¸æ˜¯å½“å‰é€‰ä¸­çš„ï¼Œåˆ™é€‰ä¸­å®ƒ
            if (!selectedIds.has(node.id)) {
                selectedIds.clear();
                selectedIds.add(node.id);
                renderTree();
            }
            
            ctxNodeId = node.id;
            ctxMenu.style.display = 'flex';
            ctxMenu.style.left = e.clientX + 'px';
            ctxMenu.style.top = e.clientY + 'px';
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
        document.addEventListener('click', () => ctxMenu.style.display = 'none');

        // è§¦å‘é‡å‘½å
        window.triggerRename = function() {
            if (ctxNodeId) {
                editingId = ctxNodeId;
                renderTree();
            }
        };

        // --- 3. æ‹–æ‹½å¯¼å‡º HTML (Drag Out) ---
        function handleDragStart(e, node) {
            // å¦‚æœå¤„äºé‡å‘½åçŠ¶æ€ï¼Œç¦æ­¢æ‹–æ‹½
            if (editingId) { e.preventDefault(); return; }

            // 1. å¦‚æœæ˜¯å•æ–‡ä»¶ï¼šå¯ç”¨ DownloadURL æ‹–æ‹½å¯¼å‡º
            if (node.type === 'file') {
                try {
                    const htmlContent = generateHTML(node.content, node.name);
                    const mime = 'text/html';
                    const filename = node.name.endsWith('.html') ? node.name : node.name + '.html';
                    const blob = new Blob([htmlContent], {type: mime});
                    const url = URL.createObjectURL(blob);
                    
                    // Chrome/Edge ä¸“å±é­”æ³•ï¼šMIME:Filename:URL
                    e.dataTransfer.setData('DownloadURL', `${mime}:${filename}:${url}`);
                } catch(err) { console.warn('Drag out not fully supported'); }
            }

            e.dataTransfer.effectAllowed = 'copyMove';
            e.dataTransfer.setData('text/plain', JSON.stringify([node.id])); // å†…éƒ¨æ ‡è¯†
        }

        // ç”Ÿæˆç‹¬ç«‹çš„ HTML å­—ç¬¦ä¸²
        function generateHTML(markdown, title) {
            // ç®€å•çš„ HTML æ¨¡æ¿ï¼ŒåŒ…å« Markmap
            return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${title}</title>
<style>svg{width:100vw;height:100vh}</style>
<script src="https://cdn.jsdelivr.net/npm/d3@7"><\/script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"><\/script>
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"><\/script>
</head>
<body>
<svg id="mindmap"></svg>
<script>
const { Markmap, Transformer } = markmap;
const transformer = new Transformer();
const { root } = transformer.transform(\`${markdown.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`);
Markmap.create('#mindmap', null, root);
<\/script>
</body>
</html>`;
        }

        // å¯¼å‡ºåŠŸèƒ½ï¼ˆèœå•è°ƒç”¨ï¼‰
        window.exportAsHTML = async function() {
            if (!ctxNodeId) return;
            const node = findNode(root, ctxNodeId);
            if (!node) return;

            if (node.type === 'file') {
                // å¯¼å‡ºå•ä¸ª HTML
                const content = generateHTML(node.content, node.name);
                downloadBlob(content, node.name + '.html', 'text/html');
            } else {
                // æ–‡ä»¶å¤¹ï¼šä½¿ç”¨ JSZip æ‰“åŒ…
                const zip = new JSZip();
                
                function addFolderToZip(folderNode, zipFolder) {
                    folderNode.children.forEach(child => {
                        if (child.type === 'file') {
                            const html = generateHTML(child.content, child.name);
                            zipFolder.file(child.name + '.html', html);
                        } else {
                            const subFolder = zipFolder.folder(child.name);
                            addFolderToZip(child, subFolder);
                        }
                    });
                }
                
                addFolderToZip(node, zip);
                const blob = await zip.generateAsync({type:"blob"});
                downloadBlob(blob, node.name + '.zip', 'application/zip');
                alert('æ–‡ä»¶å¤¹å·²æ‰“åŒ…ä¸º Zip ä¸‹è½½ (æµè§ˆå™¨é™åˆ¶ç›´æ¥æ‹–æ‹½æ–‡ä»¶å¤¹)');
            }
        };

        function downloadBlob(content, filename, mime) {
            const blob = content instanceof Blob ? content : new Blob([content], {type: mime});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }

        // --- 4. å¤–éƒ¨æ–‡ä»¶æ‹–å…¥ (Import Drag) ---
        const container = document.getElementById('treeContainer');
        container.ondragover = e => { e.preventDefault(); container.classList.add('drag-enter-active'); };
        container.ondragleave = e => { container.classList.remove('drag-enter-active'); };
        container.ondrop = async e => {
            e.preventDefault(); container.classList.remove('drag-enter-active');
            
            // å¤„ç†å¤–éƒ¨æ–‡ä»¶
            if (e.dataTransfer.files && e.dataTransfer.files.length) {
                for (let file of e.dataTransfer.files) {
                    const text = await readFile(file);
                    root.children.push({ id:Date.now()+Math.random()+'', name:file.name, type:'file', content:text });
                }
                renderTree();
            }
        };

        // --- 5. åŸºç¡€äº¤äº’é€»è¾‘ (Copy/Paste/Resizer) ---
        // (è¿™éƒ¨åˆ†é€»è¾‘æ²¿ç”¨ä¸Šä¸€ç‰ˆæœ€ç¨³å®šçš„ç‰ˆæœ¬ï¼Œçœç•¥éƒ¨åˆ†é‡å¤ä»£ç ä»¥ä¿æŒç²¾ç®€ï¼Œé‡ç‚¹å±•ç¤ºæ–°åŠŸèƒ½)
        
        // å†…éƒ¨æ‹–æ‹½ç§»åŠ¨
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDrop(e, target) {
            e.preventDefault(); e.stopPropagation();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if(e.dataTransfer.files.length) return; // å¿½ç•¥æ–‡ä»¶Drop
            if(target.type!=='folder') return;
            // ç®€å•ç§»åŠ¨é€»è¾‘
            const data = e.dataTransfer.getData('text/plain');
            if(data) {
                try {
                    const ids = JSON.parse(data);
                    ids.forEach(id => {
                        const s = findNode(root, id);
                        if(s && s.id !== target.id && !isDesc(s,target.id)) {
                            if(rmNode(root, id)) target.children.push(s);
                        }
                    });
                    target.isOpen=true; renderTree();
                } catch(e){}
            }
        }

        function handleItemClick(e, node) {
            e.stopPropagation();
            if(e.ctrlKey){ if(selectedIds.has(node.id)) selectedIds.delete(node.id); else selectedIds.add(node.id); }
            else { selectedIds.clear(); selectedIds.add(node.id); }
            if(node.type==='file') loadFile(node);
            renderTree();
        }

        // è¾…åŠ©å‡½æ•°
        function findNode(n,id){if(n.id===id)return n;if(n.children)for(let c of n.children){let r=findNode(c,id);if(r)return r;}return null;}
        function isDesc(p,cid){if(!p.children)return false;for(let c of p.children)if(c.id===cid||isDesc(c,cid))return true;return false;}
        function rmNode(p,id){if(!p.children)return false;const i=p.children.findIndex(x=>x.id===id);if(i!==-1){p.children.splice(i,1);return true;}for(let c of p.children)if(rmNode(c,id))return true;return false;}
        function readFile(f){return new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsText(f);});}
        
        // é¢æ¿è°ƒèŠ‚
        setupResizer('resizer-left','left-panel','left');
        setupResizer('resizer-middle','middle-panel','middle');
        function setupResizer(rid,pid,k){
            const r=document.getElementById(rid), p=document.getElementById(pid); let drag=false;
            r.onmousedown=()=>{drag=true;document.body.style.cursor='col-resize';p.style.transition='none';};
            document.onmousemove=e=>{if(drag){
                const w = k==='left'?e.clientX:(e.clientX-document.getElementById('left-panel').getBoundingClientRect().width);
                if(w>100&&w<800){p.style.width=w+'px'; savedWidths[k]=w; if(mm)mm.fit();}
            }};
            document.onmouseup=()=>{if(drag){drag=false;document.body.style.cursor='default';p.style.transition='width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), min-width 0.3s ease';}};
        }
        function togglePanel(k){
            const p=document.getElementById(k+'-panel'), r=document.getElementById('resizer-'+k);
            if(p.classList.contains('collapsed')){ p.classList.remove('collapsed'); p.style.width=savedWidths[k]+'px'; r.classList.remove('hidden'); }
            else{ p.classList.add('collapsed'); r.classList.add('hidden'); }
            setTimeout(()=>mm&&mm.fit(),350);
        }

        // ç¼–è¾‘å™¨
        const editor=document.getElementById('editor');
        function loadFile(n){ activeFileId=n.id; editor.disabled=false; editor.value=n.content||''; document.getElementById('editorStatus').textContent=n.name; renderMarkmap(n.content); }
        editor.oninput=()=>{if(activeFileId){const n=findNode(root,activeFileId);if(n){n.content=editor.value;renderMarkmap(n.content);}}};
        function renderMarkmap(v){if(mm){const{root:r}=transformer.transform(v||'');mm.setData(r);mm.fit();}}

        // åˆå§‹åŒ–
        window.onload = () => { initMarkmap(); renderTree(); };
        
        // æ¡†é€‰
        const treeContainer = document.getElementById('treeContainer');
        const selectionBox = document.getElementById('selection-box');
        let isSelecting=false, startX, startY;
        treeContainer.addEventListener('mousedown',e=>{
            if(e.target.closest('.tree-item'))return;
            if(e.button!==0)return;
            isSelecting=true;
            const r=treeContainer.getBoundingClientRect();
            startX=e.clientX-r.left+treeContainer.scrollLeft;
            startY=e.clientY-r.top+treeContainer.scrollTop;
            selectionBox.style.display='block';
            selectionBox.style.width='0';selectionBox.style.height='0';
            if(!e.ctrlKey) {selectedIds.clear();renderTree();}
        });
        treeContainer.addEventListener('mousemove',e=>{
            if(!isSelecting)return;
            const r=treeContainer.getBoundingClientRect();
            const cx=e.clientX-r.left+treeContainer.scrollLeft;
            const cy=e.clientY-r.top+treeContainer.scrollTop;
            const w=Math.abs(cx-startX), h=Math.abs(cy-startY);
            selectionBox.style.width=w+'px'; selectionBox.style.height=h+'px';
            selectionBox.style.left=Math.min(cx,startX)+'px'; selectionBox.style.top=Math.min(cy,startY)+'px';
            // ç®€å•çš„æ¡†é€‰æ£€æµ‹
            document.querySelectorAll('.tree-item').forEach(item=>{
                const ir=item.getBoundingClientRect();
                const it=ir.top-r.top+treeContainer.scrollTop;
                const il=ir.left-r.left+treeContainer.scrollLeft;
                if(Math.min(cx,startX)<il+ir.width && Math.min(cx,startX)+w>il && Math.min(cy,startY)<it+ir.height && Math.min(cy,startY)+h>it) {
                    selectedIds.add(item.dataset.id); item.classList.add('selected');
                }
            });
        });
        document.addEventListener('mouseup',()=>{isSelecting=false;selectionBox.style.display='none';});

        // å¯¼å…¥å¯¼å‡ºæ•°æ®(JSON)
        function triggerImport(){document.getElementById('fileInput').click();}
        document.getElementById('fileInput').onchange=async e=>{
            for(let f of e.target.files){
                const t=await readFile(f);
                if(f.name.endsWith('.json')){ try{const d=JSON.parse(t);if(d.id){regenId(d);root.children.push(d);}}catch(e){} }
                else root.children.push({id:Date.now()+'',name:f.name,type:'file',content:t});
            } renderTree(); e.target.value='';
        };
        function exportSelected(){
            if(!selectedIds.size)return alert('è¯·é€‰æ‹©');
            const nodes=Array.from(selectedIds).map(id=>findNode(root,id)).filter(n=>n);
            const content=JSON.stringify(nodes.length===1?nodes[0]:nodes,null,2);
            downloadBlob(content, 'export.json', 'text/plain');
        }
        function regenId(n){n.id=Date.now()+Math.random()+'';if(n.children)n.children.forEach(regenId);}
        function promptCreate(type){
            document.getElementById('modalTitle').textContent='æ–°å»º'+type;
            document.getElementById('customModal').style.display='flex';
            const inp=document.getElementById('modalInput'); inp.value=''; inp.focus();
            window.tempCreateType=type;
        }
        function confirmModal(){
            const name=document.getElementById('modalInput').value;
            if(name){
                let p=root; if(selectedIds.size===1){const n=findNode(root,Array.from(selectedIds)[0]);if(n&&n.type==='folder')p=n;}
                p.children.push({id:Date.now()+'',name,type:window.tempCreateType,content:'',children:window.tempCreateType==='folder'?[]:null,isOpen:true});
                renderTree();
            } closeModal();
        }
        function closeModal(){document.getElementById('customModal').style.display='none';}
        function deleteSelected(){if(selectedIds.size&&confirm('åˆ é™¤?')){selectedIds.forEach(id=>rmNode(root,id));selectedIds.clear();renderTree();}}

    </script>
</body>
</html>
