<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TreeMind Pro - å®Œç¾äº¤äº’ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --primary-color: #4a90e2;
            --selection-bg: #e3effd;
            --hover-bg: #f5f5f5;
            --resizer-width: 5px;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
        }

        /* --- å·¥å…·æ  --- */
        .toolbar {
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            z-index: 20;
        }
        .btn {
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid transparent;
            background: var(--primary-color);
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border-color: var(--primary-color); color: var(--primary-color); }
        .btn-icon { background: transparent; color: #555; padding: 5px; font-size: 16px; border:none; cursor: pointer; }
        .btn-icon:hover { background: #eee; border-radius: 4px; }

        /* --- ä¸»å¸ƒå±€ --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        /* å·¦ä¾§é¢æ¿ */
        #left-panel {
            width: 260px; /* åˆå§‹å®½åº¦ */
            min-width: 150px;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            /* å…³é”®ï¼šä¸å†è‡ªåŠ¨ç¼©æ”¾ï¼Œè€Œæ˜¯å›ºå®šå¸ƒå±€ */
            position: relative; 
        }

        /* æ ¸å¿ƒï¼šæ‹–æ‹½æ¡ */
        .resizer {
            width: var(--resizer-width);
            cursor: col-resize;
            background: transparent;
            border-right: 1px solid var(--border-color);
            transition: background 0.2s;
            z-index: 10;
        }
        .resizer:hover, .resizer.resizing {
            background: var(--primary-color);
        }

        /* é¢æ¿æŠ˜å  */
        .hidden-panel { display: none !important; }

        #middle-panel { width: 450px; min-width: 200px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: #fff; }
        #right-panel { flex: 1; background: #fff; position: relative; min-width: 0; }

        /* --- æ ‘å½¢åˆ—è¡¨ (æ ¸å¿ƒä¿®å¤) --- */
        .tree-container {
            flex: 1;
            overflow: auto; /* å…è®¸åŒå‘æ»šåŠ¨ */
            padding-bottom: 50px;
        }

        /* æ ‘èŠ‚ç‚¹å®¹å™¨ï¼šä¿è¯å®½åº¦æ’‘å¼€ */
        .tree-content-wrapper {
            display: inline-block; /* å…³é”®ï¼šå†…å®¹å¤šå®½å°±æ’‘å¤šå®½ï¼Œè§¦å‘æ¨ªå‘æ»šåŠ¨ */
            min-width: 100%;
        }

        .tree-item {
            display: flex;
            align-items: center;
            height: 28px; /* å›ºå®šé«˜åº¦ */
            cursor: pointer;
            white-space: nowrap; /* ç¦æ­¢æ¢è¡Œ */
            border: 1px solid transparent;
            box-sizing: border-box;
            /* Indentation via padding is calculated in JS */
        }
        
        .tree-item:hover { background-color: var(--hover-bg); }
        .tree-item.selected { background-color: var(--selection-bg); color: var(--primary-color); }
        .tree-item.drag-over { border: 2px dashed #f59e0b; background: #fffbe6; }

        .arrow { 
            width: 20px; height: 20px; line-height: 20px; text-align: center; 
            font-size: 10px; color: #999; cursor: pointer; 
            display: inline-block; flex-shrink: 0;
            transition: transform 0.1s;
        }
        .arrow:hover { color: #333; font-weight: bold; }
        .arrow.open { transform: rotate(90deg); }
        .icon { margin-right: 6px; flex-shrink: 0; }

        /* --- æ¡†é€‰ --- */
        #selection-box {
            position: absolute;
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
            display: none;
            pointer-events: none;
            z-index: 100;
        }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 999;
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 6px; width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 10px;
        }
        .modal-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        .modal-input:focus { border-color: var(--primary-color); }

        textarea { width: 100%; height: 100%; border: none; padding: 20px; resize: none; outline: none; background: #fafafa; font-family: 'Consolas', monospace; box-sizing: border-box; }
        #markmap-container { width: 100%; height: 100%; }
        svg { width: 100%; height: 100%; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="customModal">
        <div class="modal-box">
            <div style="font-weight:bold" id="modalTitle">Title</div>
            <input type="text" class="modal-input" id="modalInput">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:5px;">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="confirmModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <strong>TreeMind Pro</strong>
        <div style="width:1px; height:15px; background:#ddd;"></div>
        <button class="btn btn-icon" title="Toggle Left" onclick="togglePanel('left')">ğŸ“š</button>
        <button class="btn btn-icon" title="Toggle Editor" onclick="togglePanel('middle')">ğŸ“</button>
        <div style="flex:1"></div>
        <button class="btn btn-icon" title="Collapse All" onclick="collapseAll()">ğŸ”½</button>
        <button class="btn btn-icon" title="Copy" onclick="copyNodes()">ğŸ“‹</button>
        <button class="btn btn-icon" title="Cut" onclick="cutNodes()">âœ‚ï¸</button>
        <button class="btn btn-icon" title="Paste" onclick="pasteNodes()">ğŸ“Œ</button>
        <div style="width:1px; height:15px; background:#ddd;"></div>
        <button class="btn" onclick="triggerImport()">ğŸ“¥ å¯¼å…¥</button>
        <button class="btn btn-outline" onclick="exportSelected()">ğŸ“¤ å¯¼å‡º</button>
        <input type="file" id="fileInput" multiple>
    </div>

    <div class="main-container" id="mainContainer">
        
        <div id="left-panel">
            <div style="padding:10px; border-bottom:1px solid #ddd; background:#f9f9f9; display:flex; gap:5px; flex-shrink: 0;">
                <button class="btn btn-sm" onclick="promptCreate('file')">ğŸ“„ æ–‡ä»¶</button>
                <button class="btn btn-sm" onclick="promptCreate('folder')">ğŸ“‚ ç›®å½•</button>
                <button class="btn btn-icon" style="color:red; margin-left:auto;" onclick="deleteSelected()">ğŸ—‘ï¸</button>
            </div>
            <div class="tree-container" id="treeContainer">
                <div id="selection-box"></div>
                <div class="tree-content-wrapper" id="treeContent"></div>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div id="middle-panel">
            <div style="padding:8px; background:#f1f1f1; border-bottom:1px solid #ddd; font-size:12px; color:#666; flex-shrink: 0;" id="editorStatus">...</div>
            <textarea id="editor" disabled></textarea>
        </div>

        <div id="right-panel">
            <div id="markmap-container"></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        let root = { id: 'root', name: 'Root', type: 'folder', children: [], isOpen: true };
        let selectedIds = new Set();
        let activeFileId = null;
        let clipboard = { nodes: [], mode: null };

        // Markmap
        const { Markmap, Transformer } = markmap;
        const transformer = new Transformer();
        let mm;
        
        function initMarkmap() {
            document.getElementById('markmap-container').innerHTML = '<svg id="mindmap"></svg>';
            mm = Markmap.create('#mindmap', null, {});
        }

        // --- 1. æ¸²æŸ“ (ä¿®å¤äº†å®½åº¦å’Œç¼©è¿›é—®é¢˜) ---
        function renderTree() {
            const container = document.getElementById('treeContent');
            container.innerHTML = '';

            function createNodeEl(node, level) {
                const div = document.createElement('div');
                div.className = 'tree-item';
                div.dataset.id = node.id;
                
                // åˆšæ€§ç¼©è¿›ï¼šä½¿ç”¨ padding-leftï¼Œä¸å†ä¾èµ– span æŒ¤å‹
                div.style.paddingLeft = (level * 20 + 10) + 'px'; 

                if (selectedIds.has(node.id)) div.classList.add('selected');

                // æ‹–æ‹½å±æ€§
                div.draggable = true;
                div.ondragstart = (e) => handleDragStart(e, node);
                div.ondragover = (e) => handleDragOver(e);
                div.ondrop = (e) => handleDrop(e, node);

                // ç‚¹å‡»äº‹ä»¶
                div.onclick = (e) => handleItemClick(e, node);
                div.ondblclick = (e) => {
                    e.stopPropagation();
                    if(node.type==='folder') { node.isOpen = !node.isOpen; renderTree(); }
                };

                // ç®­å¤´é€»è¾‘
                const isFolder = node.type === 'folder';
                const hasChildren = isFolder && node.children.length > 0;
                
                const arrow = document.createElement('span');
                arrow.className = (hasChildren && node.isOpen) ? 'arrow open' : 'arrow';
                arrow.textContent = hasChildren ? 'â–¶' : '';
                arrow.onclick = (e) => {
                    e.stopPropagation();
                    node.isOpen = !node.isOpen;
                    renderTree();
                };

                const icon = document.createElement('span');
                icon.className = 'icon';
                icon.textContent = isFolder ? 'ğŸ“‚' : 'ğŸ“„';

                const text = document.createElement('span');
                text.textContent = node.name;

                div.appendChild(arrow);
                div.appendChild(icon);
                div.appendChild(text);
                container.appendChild(div);

                if (isFolder && node.isOpen && node.children) {
                    node.children.forEach(c => createNodeEl(c, level + 1));
                }
            }

            if(root.children.length === 0) {
                container.innerHTML = '<div style="padding:20px;color:#999;font-size:12px;">ç©ºç›®å½•</div>';
            } else {
                root.children.forEach(c => createNodeEl(c, 0));
            }
        }

        // --- 2. æ‹–æ‹½è°ƒæ•´å®½åº¦ (Resizer Logic) ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize'; // å¼ºåˆ¶å…¨å±€å…‰æ ‡
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            // è®¡ç®—æ–°å®½åº¦ï¼Œé™åˆ¶æœ€å° 150pxï¼Œæœ€å¤§ 800px
            const newWidth = Math.max(150, Math.min(e.clientX, 800));
            leftPanel.style.width = newWidth + 'px';
            // å¿…é¡»ï¼šå¦‚æœåœ¨æ‹–åŠ¨ä¸­ï¼Œmarkmapå¯èƒ½éœ€è¦è°ƒæ•´å¤§å°
            if(mm) mm.fit(); 
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = 'default';
            }
        });

        // --- 3. äº¤äº’é€»è¾‘ (å¤šé€‰/å•é€‰) ---
        function handleItemClick(e, node) {
            e.stopPropagation();
            if (e.ctrlKey || e.metaKey) {
                if (selectedIds.has(node.id)) selectedIds.delete(node.id);
                else selectedIds.add(node.id);
            } else {
                selectedIds.clear();
                selectedIds.add(node.id);
                if(node.type === 'folder') node.isOpen = !node.isOpen; // å•å‡»ä¹Ÿåˆ‡æ¢æŠ˜å 
            }
            if (node.type === 'file') loadFile(node);
            renderTree();
        }

        // --- 4. æ¡†é€‰é€»è¾‘ ---
        const treeContainer = document.getElementById('treeContainer');
        const selectionBox = document.getElementById('selection-box');
        let isSelecting = false;
        let startX, startY;

        treeContainer.addEventListener('mousedown', (e) => {
            if (e.target.closest('.tree-item')) return;
            isSelecting = true;
            const rect = treeContainer.getBoundingClientRect();
            startX = e.clientX - rect.left + treeContainer.scrollLeft;
            startY = e.clientY - rect.top + treeContainer.scrollTop;
            selectionBox.style.display = 'block';
            selectionBox.style.width = '0'; selectionBox.style.height = '0';
            if(!e.ctrlKey) { selectedIds.clear(); renderTree(); }
        });

        treeContainer.addEventListener('mousemove', (e) => {
            if (!isSelecting) return;
            e.preventDefault();
            const rect = treeContainer.getBoundingClientRect();
            const curX = e.clientX - rect.left + treeContainer.scrollLeft;
            const curY = e.clientY - rect.top + treeContainer.scrollTop;
            
            const w = Math.abs(curX - startX);
            const h = Math.abs(curY - startY);
            selectionBox.style.width = w+'px'; selectionBox.style.height = h+'px';
            selectionBox.style.left = Math.min(curX, startX)+'px';
            selectionBox.style.top = Math.min(curY, startY)+'px';
            
            checkSelection(Math.min(curX, startX), Math.min(curY, startY), w, h);
        });

        document.addEventListener('mouseup', () => { isSelecting = false; selectionBox.style.display='none'; });

        function checkSelection(bx, by, bw, bh) {
            const items = document.querySelectorAll('.tree-item');
            const cRect = treeContainer.getBoundingClientRect();
            items.forEach(item => {
                const iRect = item.getBoundingClientRect();
                const iTop = iRect.top - cRect.top + treeContainer.scrollTop;
                const iLeft = iRect.left - cRect.left + treeContainer.scrollLeft;
                if (bx < iLeft + iRect.width && bx + bw > iLeft && by < iTop + iRect.height && by + bh > iTop) {
                    selectedIds.add(item.dataset.id);
                    item.classList.add('selected');
                }
            });
        }

        // --- 5. å¯¼å…¥å¯¼å‡º (æ”¯æŒæ‰¹é‡) ---
        function triggerImport() { document.getElementById('fileInput').click(); }
        document.getElementById('fileInput').addEventListener('change', async (e)=>{
            for(let f of e.target.files){
                const t = await readFile(f);
                if(f.name.endsWith('.json')){
                    try {
                        const d = JSON.parse(t);
                        if(Array.isArray(d)) { d.forEach(n=>{ regenId(n); root.children.push(n); }); }
                        else if(d.id && d.children) { regenId(d); root.children.push(d); }
                        else { root.children.push({id:Date.now()+'', name:f.name, type:'file', content:t}); }
                    } catch(e){ root.children.push({id:Date.now()+'', name:f.name, type:'file', content:t}); }
                } else {
                    root.children.push({id:Date.now()+'', name:f.name, type:'file', content:t});
                }
            }
            renderTree(); e.target.value='';
        });

        function exportSelected() {
            if(!selectedIds.size) return alert('è¯·é€‰æ‹©');
            const nodes = Array.from(selectedIds).map(id=>findNode(root,id)).filter(n=>n);
            let content, fname;
            if(nodes.length===1){
                content = nodes[0].type==='folder'?JSON.stringify(nodes[0],null,2):nodes[0].content;
                fname = nodes[0].name + (nodes[0].type==='folder'?'.json':'');
            } else {
                content = JSON.stringify(nodes,null,2);
                fname = `batch_export_${Date.now()}.json`;
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content],{type:'text/plain'}));
            a.download = fname;
            a.click();
        }

        // --- è¾…åŠ© ---
        function regenId(n){ n.id=Date.now()+Math.random()+''; if(n.children)n.children.forEach(regenId); }
        function readFile(f){return new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsText(f);});}
        
        let dragSrc=[];
        function handleDragStart(e,n){ dragSrc=selectedIds.has(n.id)?Array.from(selectedIds):[n.id]; e.dataTransfer.effectAllowed='move'; }
        function handleDragOver(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDrop(e,t){
            e.preventDefault(); e.stopPropagation();
            document.querySelectorAll('.drag-over').forEach(x=>x.classList.remove('drag-over'));
            if(t.type!=='folder')return;
            dragSrc.forEach(id=>{
                const s=findNode(root,id);
                if(s&&s.id!==t.id&&!isDesc(s,t.id)){ if(rmNode(root,id)) t.children.push(s); }
            });
            t.isOpen=true; renderTree();
        }

        function findNode(n,id){if(n.id===id)return n;if(n.children)for(let c of n.children){let r=findNode(c,id);if(r)return r;}return null;}
        function isDesc(p,cid){if(!p.children)return false;for(let c of p.children)if(c.id===cid||isDesc(c,cid))return true;return false;}
        function rmNode(p,id){if(!p.children)return false;const i=p.children.findIndex(x=>x.id===id);if(i!==-1){p.children.splice(i,1);return true;}for(let c of p.children)if(rmNode(c,id))return true;return false;}

        // å‰ªè´´æ¿
        function copyNodes(){if(selectedIds.size) clipboard={mode:'copy',nodes:Array.from(selectedIds).map(id=>JSON.stringify(findNode(root,id)))};}
        function cutNodes(){if(selectedIds.size) clipboard={mode:'cut',nodes:Array.from(selectedIds)};}
        function pasteNodes(){
            let p=root; if(selectedIds.size===1){const n=findNode(root,Array.from(selectedIds)[0]);if(n&&n.type==='folder')p=n;}
            if(clipboard.mode==='copy'){
                clipboard.nodes.forEach(s=>{const n=JSON.parse(s); regenId(n); n.name+='(å‰¯æœ¬)'; p.children.push(n);});
            } else if(clipboard.mode==='cut'){
                clipboard.nodes.forEach(id=>{const n=findNode(root,id);if(n&&rmNode(root,id))p.children.push(n);}); clipboard.mode=null;
            }
            p.isOpen=true; renderTree();
        }
        function deleteSelected(){if(selectedIds.size&&confirm('åˆ é™¤?')){selectedIds.forEach(id=>rmNode(root,id));selectedIds.clear();renderTree();}}
        function collapseAll(){ function cls(n){if(n.children){n.isOpen=false;n.children.forEach(cls);}} root.children.forEach(cls); renderTree(); }

        // å¼¹çª—
        let cb=null; const modal=document.getElementById('customModal'); const inp=document.getElementById('modalInput');
        function promptCreate(type){ document.getElementById('modalTitle').textContent='æ–°å»º'+(type==='file'?'æ–‡ä»¶':'ç›®å½•'); inp.value=''; modal.style.display='flex'; inp.focus(); cb=name=>{
            let p=root; if(selectedIds.size===1){const n=findNode(root,Array.from(selectedIds)[0]);if(n&&n.type==='folder'){p=n;p.isOpen=true;}}
            p.children.push({id:Date.now()+'',name,type,content:type==='file'?'# '+name:'',children:type==='folder'?[]:null,isOpen:true});
            renderTree();
        };}
        function confirmModal(){if(inp.value&&cb)cb(inp.value);closeModal();}
        function closeModal(){modal.style.display='none';}
        inp.onkeydown=e=>{if(e.key==='Enter')confirmModal();}

        // ç¼–è¾‘å™¨
        const editor=document.getElementById('editor');
        function loadFile(n){ activeFileId=n.id; editor.disabled=false; editor.value=n.content||''; document.getElementById('editorStatus').textContent=n.name; renderMarkmap(n.content); }
        editor.oninput=()=>{if(activeFileId){const n=findNode(root,activeFileId);if(n){n.content=editor.value;renderMarkmap(n.content);}}};
        function renderMarkmap(v){if(mm){const{root:r}=transformer.transform(v||'');mm.setData(r);mm.fit();}}

        function togglePanel(id){
            const el=document.getElementById(id==='left'?'left-panel':'middle-panel');
            el.classList.toggle('hidden-panel');
            if(id==='left'){
                // éšè—Resizer
                document.getElementById('resizer').style.display = el.classList.contains('hidden-panel') ? 'none' : 'block';
            }
            setTimeout(()=>mm&&mm.fit(),300);
        }

        window.onload=()=>{initMarkmap();renderTree();}
    </script>
</body>
</html>
